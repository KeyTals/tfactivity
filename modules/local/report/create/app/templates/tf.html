{% extends "base.html" %} {% block tabs %} {% from 'macros.html' import tabs %} {{ tabs(active="tf") }} {% endblock %}
{% block content %}

<div class="ranking-container">
  <div class="stretch-row">
    <input class="form-input" type="text" id="filter-tf" placeholder="TF Name" />
  </div>
  <div class="stretch-row">
    {% for assay in assays %}
    <span id="assay-{{assay}}" class="chip stretchable c-hand active">{{ assay }}</span>
    {% endfor %}
  </div>
  {% for tf, dcgs in ranking.items() %}
  <div class="card tf-card" id="tf-{{tf}}" style="width: 100%">
    <div class="accordion">
      <input type="checkbox" id="accordion-{{ tf | lower }}" name="accordion-checkbox" hidden />
      <label class="accordion-header c-hand" for="accordion-{{ tf | lower }}">
        <i class="icon icon-arrow-right mr-1"></i>
        {{ tf }}
        <div class="float-right">
          <button class="btn btn-primary btn-sm">Details</button>
          {% for assay in assays %} {% if assay not in dcgs %} {% set color = '' %} {% else %} {% set dcg = dcgs[assay]
          %} {% if dcg >= 2/3 %} {% set color='label-success' %} {% elif dcg >=1/3 %} {% set color='label-warning' %} {%
          else %} {% set color='label-error' %} {% endif %} {% endif %}
          <span class="label label-rounded {{color}}" style="background-color: {{ color }};"> {{ assay }} </span>
          {% endfor %}
        </div>
      </label>
      <div class="accordion-body">
        <h2>Hello</h2>
      </div>
    </div>
  </div>
  {% endfor %}
</div>
{% endblock %} {% block scripts %}
<script>
  // Add click event to each assay chip
  // Use all elements with id starting with 'assay-'
  const assayChips = Array.from(document.querySelectorAll('[id^="assay-"]'));

  const ranking = {{ ranking | tojson }};

  const updateRanking = function (activeAssays) {
      const tfScores = Object.entries(ranking).reduce(function (acc, [tf, dcgs]) {
          const score = activeAssays.reduce(function (acc, assay) {
              return acc + (dcgs[assay] || 0);
          }, 0) / activeAssays.length;

          acc[tf] = score;
          return acc;
      }, {});

      const tfOrder = Object.keys(tfScores).sort(function (a, b) {
          return tfScores[b] - tfScores[a];
      });

      const tfRank = tfOrder.reduce(function (acc, tf, index) {
          acc[tf] = index;
          return acc;
      }, {});

      Object.entries(tfRank).forEach(function ([tf, rank]) {
          const tfCard = document.getElementById(`tf-${tf}`);
          tfCard.style.order = rank;
      });
  };

  updateRanking(assayChips.map(function (chip) {
      return chip.textContent;
  }));

  assayChips.forEach(function (element) {
      element.addEventListener('click', function () {
          if (element.classList.contains('c-not-allowed')) {
              return;
          }

          element.classList.toggle('active');

          const activeAssayChips = assayChips.filter(function (chip) {
              return chip.classList.contains('active');
          });

          if (activeAssayChips.length === 1) {
              activeAssayChips[0].classList.remove('c-hand');
              activeAssayChips[0].classList.add('c-not-allowed');
          } else {
              activeAssayChips.forEach(function (chip) {
                  chip.classList.remove('c-not-allowed');
                  chip.classList.add('c-hand');
              });
          }

          const activeAssays = activeAssayChips.map(function (chip) {
              return chip.textContent;
          });

          updateRanking(activeAssays);
      });
  });

  const filterTf = document.getElementById('filter-tf');
  filterTf.addEventListener('input', function () {
      const filter = filterTf.value.toLowerCase();
      const tfCards = Array.from(document.querySelectorAll('.tf-card'));

      tfCards.forEach(function (card) {
          const tf = card.id.replace('tf-', '');
          if (tf.toLowerCase().includes(filter)) {
              card.style.display = 'block';
          } else {
              card.style.display = 'none';
          }
      });
  });
</script>
{% endblock %}

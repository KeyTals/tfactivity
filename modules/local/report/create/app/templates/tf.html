{% extends "base.html" %}

{% block tabs %}
{% from 'macros.html' import tabs %}
{{ tabs(active="tf") }}
{% endblock %}

{% block content %}

<div class="ranking-container">
    <div class="stretch-row">
        {% for assay in assays %}
        <span id="assay-{{assay}}" class="chip stretchable clickable active">{{ assay }}</span>
        {% endfor %}
    </div>
    {% for tf, dcgs in ranking.items() %}
    <div class="card tf-card" id="tf-{{tf}}" style="width: 100%;">
        <div class="accordion">
            <input type="checkbox" id="accordion-{{ tf | lower }}" name="accordion-checkbox" hidden>
            <label class="accordion-header clickable" for="accordion-{{ tf | lower }}">
                <i class="icon icon-arrow-right mr-1"></i>
                {{ tf }}
                {% for assay in assays | reverse %}
                {% if assay not in dcgs %}
                {% set color = 'grey' %}
                {% else %}
                {% set dcg = dcgs[assay] %}
                {% if dcg >= 2/3 %} {% set color='green' %} {% elif dcg >=1/3 %} {% set color='orange' %} {%
                else %} {% set color='red' %} {% endif %} {% endif %} <button class="btn btn-primary btn-sm float-right"
                    style="background-color: {{ color }}; border: none;">
                    {{ assay }}
                </button>
                {% endfor %}
                <button class="btn btn-primary btn-sm float-right">Details</button>
            </label>
            <div class="accordion-body">
                <h2>Hello</h2>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endblock %}

{% block scripts %}
<script>
    // Add click event to each assay chip
    // Use all elements with id starting with 'assay-'
    const assayChips = Array.from(document.querySelectorAll('[id^="assay-"]'));

    const ranking = {{ ranking | tojson }};

    const updateRanking = function (activeAssays) {
        const tfScores = Object.entries(ranking).reduce(function (acc, [tf, dcgs]) {
            const score = activeAssays.reduce(function (acc, assay) {
                return acc + (dcgs[assay] || 0);
            }, 0) / activeAssays.length;

            acc[tf] = score;
            return acc;
        }, {});

        const tfOrder = Object.keys(tfScores).sort(function (a, b) {
            return tfScores[b] - tfScores[a];
        });

        const tfRank = tfOrder.reduce(function (acc, tf, index) {
            acc[tf] = index;
            return acc;
        }, {});

        Object.entries(tfRank).forEach(function ([tf, rank]) {
            const tfCard = document.getElementById(`tf-${tf}`);
            tfCard.style.order = rank;
        });
    };

    updateRanking(assayChips.map(function (chip) {
        return chip.textContent;
    }));

    assayChips.forEach(function (element) {
        element.addEventListener('click', function () {
            if (element.classList.contains('forbidden')) {
                return;
            }

            element.classList.toggle('active');

            const activeAssayChips = assayChips.filter(function (chip) {
                return chip.classList.contains('active');
            });

            if (activeAssayChips.length === 1) {
                activeAssayChips[0].classList.remove('clickable');
                activeAssayChips[0].classList.add('forbidden');
            } else {
                activeAssayChips.forEach(function (chip) {
                    chip.classList.remove('forbidden');
                    chip.classList.add('clickable');
                });
            }

            const activeAssays = activeAssayChips.map(function (chip) {
                return chip.textContent;
            });

            updateRanking(activeAssays);
        });
    });
</script>
{% endblock %}